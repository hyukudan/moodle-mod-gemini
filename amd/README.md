# AMD JavaScript Modules for mod_gemini

This directory contains JavaScript modules following Moodle's AMD (Asynchronous Module Definition) pattern.

## Structure

- `src/` - Source JavaScript files (edit these)
- `build/` - Minified/compiled JavaScript files (generated by Grunt)

## Modules

### 1. generator.js
Content generation UI logic:
- Type selection wizard
- Prompt inspiration chips
- Task enqueueing
- Status polling for background tasks

**Usage in PHP:**
```php
$PAGE->requires->js_call_amd('mod_gemini/generator', 'init', [
    'geminiId' => $gemini->id,
    'ajaxUrl' => 'ajax.php',
    'strings' => [
        'generating_msg' => get_string('generating_msg', 'mod_gemini'),
        'error_prefix' => get_string('error_prefix', 'mod_gemini'),
        // ... other strings
    ]
]);
```

### 2. tools.js
Teaching assistant tools:
- Rubric generator
- Content editor
- Regenerate functionality

**Usage in PHP:**
```php
$PAGE->requires->js_call_amd('mod_gemini/tools', 'init', [
    'geminiId' => $gemini->id,
    'ajaxUrl' => 'ajax.php',
    'rawContent' => $content->content,
    'strings' => [
        'saving' => get_string('saving', 'mod_gemini'),
        'confirm_regenerate' => get_string('confirm_regenerate', 'mod_gemini'),
        // ... other strings
    ]
]);
```

### 3. viewer.js
Content display interactivity:
- Flashcard flip/navigation
- Grade completion

**Usage in PHP:**
```php
$PAGE->requires->js_call_amd('mod_gemini/viewer', 'init', [
    'geminiId' => $gemini->id,
    'totalCards' => count($data->cards),
    'ajaxUrl' => 'ajax.php',
    'strings' => [
        'next_card' => get_string('next_card', 'mod_gemini'),
        'finish' => get_string('finish', 'mod_gemini'),
        // ... other strings
    ]
]);
```

## Building

### Prerequisites

1. Node.js and npm installed
2. Moodle development environment

### Build Commands

```bash
# Install dependencies (first time only)
npm install

# Build AMD modules (compile src/ to build/)
npm run build

# Watch for changes and auto-rebuild
npm run watch

# Lint JavaScript
npm run lint
```

### Using Moodle's Grunt

If you want to use Moodle's Grunt configuration:

```bash
# From Moodle root directory
cd /path/to/moodle
grunt amd --root=mod/gemini

# Or set MOODLE_DIR environment variable
export MOODLE_DIR=/path/to/moodle
cd mod/gemini
grunt amd
```

## Development Notes

1. **Always edit `src/` files, never `build/` files**
   - The build/ files are auto-generated

2. **Follow Moodle coding standards**
   - Use proper JSDoc comments
   - Follow eslint rules
   - Use core/ajax for AJAX calls where possible

3. **Dependencies**
   - `jquery` - jQuery library
   - `core/ajax` - Moodle's AJAX API
   - `core/notification` - Moodle's notification system
   - `core/modal_factory` - Modal dialogs (for tools.js)

4. **Testing**
   - Test in Moodle after building
   - Clear browser cache if changes don't appear
   - Check browser console for errors

## Migration from Inline JavaScript

These AMD modules replace the inline `<script>` tags in view.php:
- Lines 121-236: Now in **tools.js**
- Lines 329-398: Now in **viewer.js** (flashcards)
- Lines 545-711: Now in **generator.js**

Benefits:
- Better code organization
- Proper dependency management
- Minification and caching
- Reusability across pages
- Follows Moodle best practices
